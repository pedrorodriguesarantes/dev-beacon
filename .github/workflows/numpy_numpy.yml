name: Generate Metrics and Commit for numpy (owner) numpy (project)

env:
  API_KEY: ${{ secrets.API_KEY }}

on:
  schedule:
    - cron: '0 12 * * 3' # Runs every Monday at 00:00 UTC
  workflow_dispatch: # Allows manual trigger from Actions tab

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 1240

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r backend/requirements.txt

    - name: Run Extraction Scripts (Issues Part 1)
      run: |
        cd backend/functions
        python issueExtractor.py numpy numpy $API_KEY 0 5000

    - name: Run Extraction Scripts (Issues Part 2) 
      run: |
        cd backend/functions
        python issueExtractor.py numpy numpy $API_KEY 5000 10000
    
    - name: Run Extraction Scripts (Issues Part 3)
      run: |
        cd backend/functions
        python issueExtractor.py numpy numpy $API_KEY 10000

    - name: Run Extraction Scripts (Pull Requests Part 1)
      run: |
        cd backend/functions
        python pullRequestExtractor.py numpy numpy $API_KEY 0 5000

    - name: Run Extraction Scripts (Pull Requests Part 2) 
      run: |
        cd backend/functions
        python pullRequestExtractor.py numpy numpy $API_KEY 5000 10000
     
    - name: Run Extraction Scripts (Pull Requests Part 3)
      run: |
        cd backend/functions
        python pullRequestExtractor.py numpy numpy $API_KEY 10000

    - name: Run Extraction Scripts (Milestones)
        python milestoneExtractor.py numpy numpy $API_KEY

    - name: List files in metrics folder
      run: |
        sudo apt-get update
        sudo apt-get install -y tree
        tree -L 3   # Adjust depth with -L

    - name: Run Processing Scripts
      run: |
        cd backend/functions
        python productivityISProcessing.py numpy numpy
        python productivityPRProcessing.py numpy numpy

    - name: Commit and Push Results
      run: |
        git config --global user.name "GitHub Actions Bot"
        git config --global user.email "pedrorodriguesarantes@gmail.com"
        git add metrics
        git commit -m "Update metrics JSON metrics for numpy (org) numpy (project) [skip ci]" || echo "No changes to commit"
        git push